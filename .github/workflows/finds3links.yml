name: Find S3 Links

on:
  workflow_dispatch:
    inputs:
      target_url:
        description: "URL do site a ser verificado (ex.: https://app.exemplo.com)"
        required: true
        default: "https://app.exemplo.com"

permissions:
  contents: read

jobs:
  find-s3:
    runs-on: ubuntu-latest
    steps:
      - name: Preparar ambiente
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y curl jq || true
          mkdir -p artifacts
          echo "" > artifacts/s3_found.txt
          echo "[]" > artifacts/results.json

      - name: Buscar e testar links S3
        id: run
        shell: bash
        env:
          URL: ${{ inputs.target_url }}
        run: |
          set -euo pipefail
          echo "Verificando: $URL"
          HTML="artifacts/page.html"
          CAND="artifacts/candidates.txt"
          RES="artifacts/results.json"
          FOUND="artifacts/s3_found.txt"

          # baixar página
          curl -fsSL "$URL" -o "$HTML" || { echo "⚠️ Não foi possível acessar $URL"; exit 0; }

          # extrair possíveis links S3
          grep -Eoi '(https?://[^"'\'' ]+\.s3[^"'\'' ]+\.amazonaws\.com[^"'\'' ]*)' "$HTML" | sort -u > "$CAND" || true

          echo "Possíveis links S3 encontrados:"
          cat "$CAND" || echo "(nenhum link encontrado)"
          echo ""

          RESULTS=()
          FOUND_URL=""
          while IFS= read -r link; do
            [ -z "$link" ] && continue
            code=$(curl -s -I -L --max-time 8 "$link" | awk '/^HTTP/{print $2}' | tail -n1)
            entry=$(jq -n --arg url "$link" --arg code "$code" '{url:$url, http_code:$code}')
            RESULTS+=("$entry")

            if [ "$code" = "200" ] && [ -z "$FOUND_URL" ]; then
              FOUND_URL="$link"
            fi
          done < "$CAND"

          printf '%s\n' "${RESULTS[@]}" | jq -s '.' > "$RES"

          if [ -n "$FOUND_URL" ]; then
            echo "✅ Bucket público encontrado:"
            echo "$FOUND_URL" | tee "$FOUND"
          else
            echo "❌ Nenhum bucket público encontrado."
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: s3-scan-results
          path: artifacts/
